<script>
import vulnerabilitySeveritiesCountQuery from '../graphql/queries/vulnerability_severities_count.query.graphql';
import { DASHBOARD_TYPES } from '../store/constants';
import eventHub from '../utils/event_hub';
import VulnerabilityCountListLayout from './vulnerability_count_list_layout.vue';

export default {
  components: {
    VulnerabilityCountListLayout,
  },
  inject: ['projectFullPath', 'groupFullPath', 'dashboardType'],
  props: {
    filters: {
      type: Object,
      required: false,
      default: null,
    },
  },
  data() {
    return {
      queryError: false,
      vulnerabilitiesCount: {},
    };
  },
  computed: {
    isLoading() {
      return this.$apollo.queries.vulnerabilitiesCount.loading;
    },
  },
  created() {
    eventHub.$on('vulnerabilities-updated', () =>
      this.$apollo.queries.vulnerabilitiesCount.refetch(),
    );
  },
  apollo: {
    vulnerabilitiesCount: {
      query: vulnerabilitySeveritiesCountQuery,
      variables() {
        const { dashboardType, filters } = this;
        return {
          fullPath: this.projectFullPath || this.groupFullPath,
          isInstance: dashboardType === DASHBOARD_TYPES.INSTANCE,
          isGroup: dashboardType === DASHBOARD_TYPES.GROUP,
          isProject: dashboardType === DASHBOARD_TYPES.PROJECT,
          ...filters,
        };
      },
      update(data) {
        return data[this.dashboardType]?.vulnerabilitySeveritiesCount || {};
      },
      result() {
        this.queryError = false;
      },
      error() {
        this.queryError = true;
      },
      skip() {
        return !this.filters;
      },
    },
  },
};
</script>

<template>
  <vulnerability-count-list-layout
    :show-error="queryError"
    :is-loading="isLoading"
    :vulnerabilities-count="vulnerabilitiesCount"
  />
</template>
