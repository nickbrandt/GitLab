<script>
import Filters from 'ee/security_dashboard/components/shared/vulnerability_report_filters.vue';
import VulnerabilityReportLayout from 'ee/security_dashboard/components/shared/vulnerability_report_layout.vue';
import createFlash from '~/flash';
import { vulnerabilitiesSeverityCountScopes } from '../../constants';
import projectsQuery from '../../graphql/queries/get_instance_security_dashboard_projects.query.graphql';
import { createProjectLoadingError } from '../../helpers';
import CsvExportButton from '../csv_export_button.vue';
import VulnerabilitiesCountList from '../vulnerability_count_list.vue';
import ReportNotConfigured from './instance_report_not_configured.vue';
import InstanceSecurityVulnerabilities from './instance_vulnerability_report_vulnerabilities.vue';

export default {
  components: {
    CsvExportButton,
    VulnerabilityReportLayout,
    InstanceSecurityVulnerabilities,
    Filters,
    ReportNotConfigured,
    VulnerabilitiesCountList,
  },
  props: {
    vulnerabilitiesExportEndpoint: {
      type: String,
      required: true,
    },
  },
  apollo: {
    projects: {
      query: projectsQuery,
      update(data) {
        return data.instanceSecurityDashboard.projects.nodes;
      },
      error() {
        createFlash({ message: createProjectLoadingError() });
      },
    },
  },
  data() {
    return {
      filters: {},
      projects: [],
    };
  },
  computed: {
    isLoadingProjects() {
      return this.$apollo.queries.projects.loading;
    },
    hasProjectsData() {
      return !this.isLoadingProjects && this.projects.length > 0;
    },
    shouldShowReport() {
      return this.hasProjectsData;
    },
    shouldShowEmptyState() {
      return !this.isLoadingProjects && this.projects.length === 0;
    },
  },
  methods: {
    handleFilterChange(filters) {
      this.filters = filters;
    },
  },
  vulnerabilitiesSeverityCountScopes,
};
</script>

<template>
  <vulnerability-report-layout>
    <template #header>
      <div>
        <header class="gl-my-6 gl-display-flex gl-align-items-center">
          <h2 class="gl-flex-grow-1 gl-my-0">
            {{ s__('SecurityReports|Vulnerability Report') }}
          </h2>
          <csv-export-button
            v-if="shouldShowReport"
            :vulnerabilities-export-endpoint="vulnerabilitiesExportEndpoint"
          />
        </header>
        <vulnerabilities-count-list
          v-if="shouldShowReport"
          :scope="$options.vulnerabilitiesSeverityCountScopes.instance"
          :filters="filters"
        />
      </div>
    </template>
    <template #sticky>
      <filters v-if="shouldShowReport" :projects="projects" @filterChange="handleFilterChange" />
    </template>
    <instance-security-vulnerabilities
      v-if="shouldShowReport"
      :projects="projects"
      :filters="filters"
    />
    <report-not-configured v-else-if="shouldShowEmptyState" />
  </vulnerability-report-layout>
</template>
