import { createWrapper, mount } from '@vue/test-utils';
import VulnerabilityActionButtons from 'ee/security_dashboard/components/vulnerability_action_buttons.vue';
import createStore from 'ee/security_dashboard/store';
import { VULNERABILITY_MODAL_ID } from 'ee/vue_shared/security_reports/components/constants';
import { BV_SHOW_MODAL } from '~/lib/utils/constants';
import { resetStore } from '../helpers';
import mockDataVulnerabilities from '../store/modules/vulnerabilities/data/mock_data_vulnerabilities';

describe('Security Dashboard Action Buttons', () => {
  let store;
  let wrapper;

  const createComponent = ({ ...options }) => {
    return mount(VulnerabilityActionButtons, {
      ...options,
      store,
    });
  };

  const findAllButtons = () => wrapper.findAll('.btn-group .btn');
  const findMoreInfoButton = () => wrapper.find('.js-more-info');
  const findCreateIssueButton = () => wrapper.find('.js-create-issue');
  const findDismissVulnerabilityButton = () => wrapper.find('.js-dismiss-vulnerability');
  const findUndoDismissButton = () => wrapper.find('.js-undo-dismiss');

  beforeEach(() => {
    store = createStore();
  });

  afterEach(() => {
    resetStore(store);
    wrapper.destroy();
  });

  describe('with a fresh vulnerability', () => {
    beforeEach(() => {
      wrapper = createComponent({
        propsData: {
          vulnerability: mockDataVulnerabilities[0],
          canCreateIssue: true,
          canDismissVulnerability: true,
        },
      });

      jest.spyOn(wrapper.vm.$store, 'dispatch').mockReturnValue(Promise.resolve());
    });

    it('should render three buttons in a button group', () => {
      expect(findAllButtons()).toHaveLength(3);
    });

    describe('More Info Button', () => {
      it('should render the More info button', () => {
        expect(findMoreInfoButton().exists()).toBe(true);
      });

      it('should emit an `setModalData` event and open the modal when clicked', () => {
        findMoreInfoButton().trigger('click');

        expect(wrapper.vm.$store.dispatch).toHaveBeenCalledWith('vulnerabilities/setModalData', {
          vulnerability: mockDataVulnerabilities[0],
        });
        expect(createWrapper(wrapper.vm.$root).emitted(BV_SHOW_MODAL)).toEqual([
          [VULNERABILITY_MODAL_ID],
        ]);
      });
    });

    describe('Create Issue Button', () => {
      it('should render the create issue button', () => {
        expect(findCreateIssueButton().exists()).toBe(true);
      });

      it('should emit an `createIssue` event when clicked', () => {
        findCreateIssueButton().trigger('click');

        expect(wrapper.vm.$store.dispatch).toHaveBeenCalledWith('vulnerabilities/createIssue', {
          vulnerability: mockDataVulnerabilities[0],
          flashError: true,
        });
      });

      describe('with Jira issues for vulnerabilities enabled', () => {
        beforeEach(() => {
          wrapper = createComponent({
            propsData: {
              vulnerability: mockDataVulnerabilities[8],
              canCreateIssue: true,
            },
            provide: {
              glFeatures: { jiraForVulnerabilities: true },
            },
          });
        });

        it('should render the correct tooltip', () => {
          expect(findCreateIssueButton().attributes('title')).toBe('Create Jira issue');
        });

        it('should open a new window when the create-issue button is clicked', () => {
          jest.spyOn(window, 'open').mockReturnValueOnce();

          expect(window.open).not.toHaveBeenCalled();
          findCreateIssueButton().trigger('click');

          expect(window.open).toHaveBeenCalledWith(
            mockDataVulnerabilities[8].create_jira_issue_url,
            '_blank',
          );
        });
      });
    });

    describe('Dismiss Vulnerability Button', () => {
      it('should render the dismiss vulnerability button', () => {
        expect(findDismissVulnerabilityButton().exists()).toBe(true);
      });

      it('should emit an `dismissVulnerability` event when clicked', () => {
        findDismissVulnerabilityButton().trigger('click');

        expect(wrapper.vm.$store.dispatch).toHaveBeenCalledWith(
          'vulnerabilities/dismissVulnerability',
          {
            vulnerability: mockDataVulnerabilities[0],
            flashError: true,
          },
        );
      });
    });
  });

  describe('with a vulnerbility that has an issue', () => {
    beforeEach(() => {
      wrapper = createComponent({
        propsData: {
          vulnerability: mockDataVulnerabilities[3],
        },
      });
    });

    it('should only render one button', () => {
      expect(findAllButtons()).toHaveLength(1);
    });

    it('should not render the create issue button', () => {
      expect(findCreateIssueButton().exists()).toBe(false);
    });
  });

  describe('with a vulnerability that has been dismissed', () => {
    beforeEach(() => {
      wrapper = createComponent({
        propsData: {
          vulnerability: mockDataVulnerabilities[2],
          canDismissVulnerability: true,
          isDismissed: true,
        },
      });
    });

    it('should render two buttons in a button group', () => {
      expect(findAllButtons()).toHaveLength(2);
    });

    it('should not render the dismiss vulnerability button', () => {
      expect(findDismissVulnerabilityButton().exists()).toBe(false);
    });

    it('should render the undo dismiss button', () => {
      expect(findUndoDismissButton().exists()).toBe(true);
    });
  });
});
